---
config:
  theme: base
  themeVariables:
    primaryColor: '#EF4444'
    primaryTextColor: '#fff'
    primaryBorderColor: '#EF4444'
    lineColor: '#666'
    secondaryColor: '#1a1a1a'
    tertiaryColor: '#2a2a2a'
    background: '#0a0a0a'
    mainBkg: '#1a1a1a'
    secondBkg: '#2a2a2a'
    nodeTextColor: '#fff'
    textColor: '#fff'
    edgeLabelBackground: '#1a1a1a'
  layout: elk
---

flowchart TB

Start["ğŸ“¹ Camera Stream<br/>RTSP/File Input<br/>30 FPS @ 1920x1080"] --> Ingestion["âš¡ Ingestion Service<br/>Frame Capture & Routing"]

Ingestion --> S3["â˜ï¸ S3 Storage<br/>Raw Frames Archive"]
Ingestion --> KafkaRaw["ğŸ“¬ Kafka: frames-raw"]

KafkaRaw --> Preprocess["ğŸ”§ Pre-processing Service<br/>Resize, Normalize, Tensorize"]

Preprocess --> KafkaProcessed["ğŸ“¬ Kafka: frames-processed"]

KafkaProcessed --> Detection["ğŸ¯ YOLO Detection Service<br/>Object Detection"]
KafkaProcessed --> Caption["ğŸ’¬ BLIP Captioning Service<br/>Image-to-Text"]
KafkaProcessed --> OCR["ğŸ“ EasyOCR Service<br/>Text Recognition"]
KafkaProcessed --> CLIP["ğŸ–¼ï¸ CLIP Service<br/>Multi-modal Embeddings"]

Detection --> KafkaDet["ğŸ“¬ Kafka: results-detection"]
Caption --> KafkaCap["ğŸ“¬ Kafka: results-captioning"]
OCR --> KafkaOCR["ğŸ“¬ Kafka: results-ocr"]
CLIP --> KafkaClip["ğŸ“¬ Kafka: results-clip"]

KafkaDet --> Aggregation["ğŸ”€ Aggregation Service<br/>Combine All Results"]
KafkaCap --> Aggregation
KafkaOCR --> Aggregation
KafkaClip --> Aggregation

Aggregation --> KafkaAgg["ğŸ“¬ Kafka: results-aggregated"]

KafkaAgg --> FrameMerger["ğŸ¬ Frame Merger Service<br/>Video Segment Reconstruction"]
KafkaAgg --> Business["ğŸ’¼ Business Service<br/>Rules & Validation"]
KafkaAgg --> Vectorization["ğŸ“Š Vectorization Service<br/>Text Embeddings"]
KafkaAgg --> GraphConst["ğŸ•¸ï¸ Graph Construction Service<br/>Entity & Relationship Extraction"]

FrameMerger --> KafkaSegments["ğŸ“¬ Kafka: video-segments"]

Business --> PostgreSQL["ğŸ—ƒï¸ PostgreSQL Database<br/>Structured Data Storage"]
Business --> DataLake["ğŸ“Š Data Lake (Parquet)<br/>Historical Analysis"]
Business --> Alerts["ğŸš¨ Alerting System<br/>Rules Engine"]
Business --> UI["ğŸ–¥ï¸ User Interface<br/>Real-time Dashboard"]

Vectorization --> Qdrant["ğŸ” Qdrant Vector Database<br/>Semantic Search"]
GraphConst --> Neo4j["ğŸ•¸ï¸ Neo4j Graph Database<br/>Relationship Queries"]

KafkaSegments --> VideoProcessor["ğŸ¥ Video Segment Processor<br/>Qwen 2.5 VL Analysis"]

VideoProcessor --> PostgreSQL

UI --> LLMQuery["ğŸ¤– LLM Query Service<br/>Natural Language Processing"]

LLMQuery --> Qdrant
LLMQuery --> Neo4j

Qdrant --> LLMQuery
Neo4j --> LLMQuery

LLMQuery --> LLM["ğŸŒŸ LLM (OpenAI/Anthropic)<br/>RAG-based Q&A"]

LLM --> UI
Alerts --> UI

classDef primary fill:#EF4444,stroke:#EF4444,stroke-width:2px,color:#fff
classDef secondary fill:#2a2a2a,stroke:#EF4444,stroke-width:2px,color:#fff
classDef storage fill:#1a1a1a,stroke:#666,stroke-width:2px,color:#fff
classDef kafka fill:#3a3a3a,stroke:#EF4444,stroke-width:1px,color:#fff

class Start,Ingestion,Preprocess,Detection,Caption,OCR,CLIP,Aggregation,FrameMerger,Business,Vectorization,GraphConst,VideoProcessor,LLMQuery,LLM primary
class KafkaRaw,KafkaProcessed,KafkaDet,KafkaCap,KafkaOCR,KafkaClip,KafkaAgg,KafkaSegments kafka
class S3,PostgreSQL,DataLake,Qdrant,Neo4j storage
class Alerts,UI secondary
